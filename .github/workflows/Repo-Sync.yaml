name: Repo Sync

on:
  workflow_dispatch:
  
  push:
    branches:
      - 'main'
    paths:
      - '.github/workflows/Repo-Sync.yaml'

  # schedule:
  #   - cron: "0 */8 * * *"

env:
  IsRebase: false
  onlya: true

jobs:
  packages:
    runs-on: ubuntu-latest
    steps:
      - name: Sleep Random Time
        run: sleep $(shuf -i 10-60 -n 1)
      - uses: actions/checkout@main
      - name: Rebase
        if: env.IsRebase == 'true'
        run: |
          git config --global user.email ${{ secrets.EMAIL }}
          git config --global user.name ${{ secrets.NAME }}
          git clone -b feeds https://github.com/AoThen/Openwrt-Packages --single-branch
          cd Openwrt-Packages

          git checkout --orphan latest_branch
          git add -A
          git commit -am "init commit"

          git branch -D feeds
          git branch -m feeds

      - name: Sync a packages
        if: env.onlya == 'true' && env.IsRebase == 'false'
        run: |
          git config --global user.email ${{ secrets.EMAIL }}
          git config --global user.name ${{ secrets.NAME }}
          git clone -b feeds https://github.com/AoThen/Openwrt-Packages --single-branch
          cd Openwrt-Packages

          rm -rf luci-theme-argon


          git add .
          Emoji=("🎉" "✨" "🎁" "🎈" "🎄" "🍓" "🍕" "🍉" "🌴" "🚀" "⛅" "🌈" "❤️")
          git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]}update at $(TZ='Asia/Shanghai' date +%Y-%m-%d)${Emoji[$[$RANDOM % ${#Emoji[@]}]]}"
          
      - name: Sync packages
        if: env.onlya == 'false' && env.IsRebase == 'false'
        run: |
          git config --global user.email ${{ secrets.EMAIL }}
          git config --global user.name ${{ secrets.NAME }}
          git clone -b feeds https://github.com/AoThen/Openwrt-Packages --single-branch
          cd Openwrt-Packages

          rm -rf luci-app-broadbandacc
          git clone --depth 1 https://github.com/AoThen/luci-app-broadbandacc.git luci-app-broadbandacc
          rm -rf luci-app-broadbandacc/.git

          rm -rf luci-app-vssr
          git clone --depth 1 https://github.com/AoThen/luci-app-vssr.git luci-app-vssr
          rm -rf luci-app-vssr/.git

          rm -rf luci-app-openclash
          svn export https://github.com/vernesong/OpenClash/trunk/luci-app-openclash luci-app-openclash

          rm -rf openwrt-aliyundrive
          svn export https://github.com/messense/aliyundrive-webdav/trunk/openwrt openwrt-aliyundrive

          rm -rf openwrt-alist
          git clone --depth 1 https://github.com/sbwml/luci-app-alist openwrt-alist
          rm -rf openwrt-alist/.git

          rm -rf helloworld
          git clone --depth 1 https://github.com/fw876/helloworld.git helloworld
          rm -rf helloworld/.git

          rm -rf passwall_packages
          git clone --depth 1 -b packages https://github.com/xiaorouji/openwrt-passwall.git  passwall_packages
          rm -rf passwall_packages/.git

          rm -rf passwall_luci
          git clone --depth 1 -b luci https://github.com/xiaorouji/openwrt-passwall.git  passwall_luci
          rm -rf passwall_luci/.git

          rm -rf luci-theme-argon
          git clone --depth 1 https://github.com/jerrykuku/luci-theme-argon.git luci-theme-argon


          rm -rf luci-app-argon-config
          git clone --depth 1 https://github.com/jerrykuku/luci-app-argon-config.git luci-app-argon-config
          rm -rf luci-app-argon-config/.git

          rm -rf lua-maxminddb
          git clone --depth 1 https://github.com/jerrykuku/lua-maxminddb.git  lua-maxminddb
          rm -rf lua-maxminddb/.git

          rm -rf luci-app-serverchan
          svn export https://github.com/tty228/luci-app-serverchan/trunk luci-app-serverchan

          rm -rf luci-app-broadbandacc
          svn export https://github.com/AoThen/luci-app-broadbandacc/trunk luci-app-broadbandacc

          rm -rf luci-app-ramfree
          svn export https://github.com/AoThen/luci-app-ramfree/trunk luci-app-ramfree

          rm -rf netspeedtest
          svn export https://github.com/sirpdboy/netspeedtest/trunk netspeedtest

          git add ./
          Emoji=("🎉" "🤞" "✨" "🎁" "🎈" "🎄" "🎨" "💋" "🍓" "🍕" "🍉" "💐" "🌴" "🚀" "🛸" "🗽" "⛅" "🌈" "🔥" "⛄" "🐶" "🏅" "🦄" "🐤")
          git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]}update at $(TZ='Asia/Shanghai' date +%Y-%m-%d)${Emoji[$[$RANDOM % ${#Emoji[@]}]]}"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.OPENWRT_PACKAGES }}
          repository: "AoThen/Openwrt-Packages"
          branch: "feeds"
          directory: "Openwrt-Packages"
          force: true
