name: Repo Sync

on:
  workflow_dispatch:
  
  push:
    branches:
      - 'main'
    paths:
      - '.github/workflows/Repo-Sync.yaml'

  # schedule:
  #   - cron: "0 */8 * * *"

jobs:
  packages:
    runs-on: ubuntu-latest
    steps:
      - name: Sleep Random Time
        run: sleep $(shuf -i 10-60 -n 1)
      - uses: actions/checkout@main
      # - uses: actions/setup-node@main
      #   with:
      #     node-version: 'lts/*'
      # - name: Rebase
      #   run: |
      #     git config --global user.email ${{ secrets.EMAIL }}
      #     git config --global user.name ${{ secrets.NAME }}
      #     git clone -b feeds https://github.com/AoThen/Openwrt-Packages --single-branch
      #     cd Openwrt-Packages

      #     git checkout --orphan latest_branch
      #     git add -A

      #     Emoji=("🎉" "✨" "🎁" "🎈" "🎄" "🍓" "🍕" "🍉" "🌴" "🚀" "⛅" "🌈" "❤️")
      #     git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]}update at $(TZ='Asia/Shanghai' date +%Y-%m-%d)${Emoji[$[$RANDOM % ${#Emoji[@]}]]}"

      #     git branch -D feeds
      #     git branch -m feeds
      - name: Sync packages
        run: |
          git config --global user.email ${{ secrets.EMAIL }}
          git config --global user.name ${{ secrets.NAME }}
          git clone -b Packages https://github.com/AoThen/Openwrt-Packages --single-branch
          cd Openwrt-Packages

          rm -rf luci-app-broadbandacc
          git clone --depth 1 https://github.com/AoThen/luci-app-broadbandacc.git luci-app-broadbandacc
          rm -rf luci-app-broadbandacc/.git
          
          rm -rf luci-app-vssr
          git clone --depth 1 https://github.com/AoThen/luci-app-vssr.git luci-app-vssr
          rm -rf luci-app-vssr/.git

          git add .
          Emoji=("🎉" "✨" "🎁" "🎈" "🎄" "🍓" "🍕" "🍉" "🌴" "🚀" "⛅" "🌈" "❤️")
          git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]}update at $(TZ='Asia/Shanghai' date +%Y-%m-%d)${Emoji[$[$RANDOM % ${#Emoji[@]}]]}"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.OPENWRT_PACKAGES }}
          repository: "AoThen/Openwrt-Packages"
          branch: "feeds"
          directory: "Openwrt-Packages"
          force: true

      # - name: Repo
      #   run: |
      #     bash Scripts/Sync.sh \
      #       https://github.com/immortalwrt/luci master \
      #       https://${{ github.repository_owner }}:${{ secrets.ACTION_SECRET }}@github.com/kenzok78/luci ts2js
      # - name: packages
      #   run: |
      #     bash Scripts/Sync.sh \
      #       https://github.com/immortalwrt/packages master \
      #       https://${{ github.repository_owner }}:${{ secrets.ACTION_SECRET }}@github.com/kenzok78/packages
      # - name: helloworld
      #   run: |
      #     bash Scripts/Sync.sh \
      #       https://github.com/fw876/helloworld master \
      #       https://${{ github.repository_owner }}:${{ secrets.ACTION_SECRET }}@github.com/kenzok78/helloworld
      # - name: openwrt-passwall
      #   run: |
      #     bash Scripts/Sync.sh \
      #       https://github.com/xiaorouji/openwrt-passwall packages \
      #       https://${{ github.repository_owner }}:${{ secrets.ACTION_SECRET }}@github.com/kenzok78/openwrt-passwall