name: Repo Sync

on:
  workflow_dispatch:
  
  push:
    branches:
      - 'main'
    paths:
      - '.github/workflows/Repo-Sync.yaml'

  # schedule:
  #   - cron: "0 */8 * * *"

jobs:
  packages:
    runs-on: ubuntu-latest
    steps:
      - name: Sleep Random Time
        run: sleep $(shuf -i 10-60 -n 1)
      - uses: actions/checkout@main
      # - uses: actions/setup-node@main
      #   with:
      #     node-version: 'lts/*'
      # - name: Rebase
      #   run: |
      #     git config --global user.email ${{ secrets.EMAIL }}
      #     git config --global user.name ${{ secrets.NAME }}
      #     git clone -b feeds https://github.com/AoThen/Openwrt-Packages --single-branch
      #     cd Openwrt-Packages

      #     git checkout --orphan latest_branch
      #     git add -A

      #     Emoji=("ğŸ‰" "âœ¨" "ğŸ" "ğŸˆ" "ğŸ„" "ğŸ“" "ğŸ•" "ğŸ‰" "ğŸŒ´" "ğŸš€" "â›…" "ğŸŒˆ" "â¤ï¸")
      #     git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]}update at $(TZ='Asia/Shanghai' date +%Y-%m-%d)${Emoji[$[$RANDOM % ${#Emoji[@]}]]}"

      #     git branch -D feeds
      #     git branch -m feeds
      - name: Sync packages
        run: |
          git config --global user.email ${{ secrets.EMAIL }}
          git config --global user.name ${{ secrets.NAME }}
          git clone -b feeds https://github.com/AoThen/Openwrt-Packages --single-branch
          cd Openwrt-Packages

          find ./ -type d -not -name "*.git" -exec rm -rf {} \;

          git clone --depth 1 https://github.com/AoThen/luci-app-broadbandacc.git luci-app-broadbandacc

          git clone --depth 1 https://github.com/AoThen/luci-app-vssr.git luci-app-vssr

          svn export https://github.com/vernesong/OpenClash/trunk/luci-app-openclash luci-app-openclash

          svn export https://github.com/messense/aliyundrive-webdav/trunk/openwrt openwrt-aliyundrive

          git clone --depth 1 https://github.com/sbwml/luci-app-alist openwrt-alist

          git clone --depth 1 https://github.com/fw876/helloworld.git helloworld

          git clone --depth 1 -b packages https://github.com/xiaorouji/openwrt-passwall.git  passwall_packages

          git clone --depth 1 -b luci https://github.com/xiaorouji/openwrt-passwall.git  passwall_luci

          git clone --depth 1 https://github.com/jerrykuku/luci-theme-argon.git luci-theme-argon

          git clone --depth 1 https://github.com/jerrykuku/luci-app-argon-config.git luci-app-argon-config

          git clone --depth 1 https://github.com/jerrykuku/lua-maxminddb.git  lua-maxminddb

          svn export https://github.com/tty228/luci-app-serverchan/trunk luci-app-serverchan

          svn export https://github.com/AoThen/luci-app-broadbandacc/trunk luci-app-broadbandacc

          svn export https://github.com/AoThen/luci-app-ramfree/trunk luci-app-ramfree

          svn export https://github.com/sirpdboy/netspeedtest/trunk netspeedtest

          git add ./
          Emoji=("ğŸ‰" "âœ¨" "ğŸ" "ğŸˆ" "ğŸ„" "ğŸ“" "ğŸ•" "ğŸ‰" "ğŸŒ´" "ğŸš€" "â›…" "ğŸŒˆ" "â¤ï¸")
          git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]}update at $(TZ='Asia/Shanghai' date +%Y-%m-%d)${Emoji[$[$RANDOM % ${#Emoji[@]}]]}"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.OPENWRT_PACKAGES }}
          repository: "AoThen/Openwrt-Packages"
          branch: "feeds"
          directory: "Openwrt-Packages"
          force: true

      # - name: Repo
      #   run: |
      #     bash Scripts/Sync.sh \
      #       https://github.com/immortalwrt/luci master \
      #       https://${{ github.repository_owner }}:${{ secrets.ACTION_SECRET }}@github.com/kenzok78/luci ts2js
      # - name: packages
      #   run: |
      #     bash Scripts/Sync.sh \
      #       https://github.com/immortalwrt/packages master \
      #       https://${{ github.repository_owner }}:${{ secrets.ACTION_SECRET }}@github.com/kenzok78/packages
      # - name: helloworld
      #   run: |
      #     bash Scripts/Sync.sh \
      #       https://github.com/fw876/helloworld master \
      #       https://${{ github.repository_owner }}:${{ secrets.ACTION_SECRET }}@github.com/kenzok78/helloworld
      # - name: openwrt-passwall
      #   run: |
      #     bash Scripts/Sync.sh \
      #       https://github.com/xiaorouji/openwrt-passwall packages \
      #       https://${{ github.repository_owner }}:${{ secrets.ACTION_SECRET }}@github.com/kenzok78/openwrt-passwall