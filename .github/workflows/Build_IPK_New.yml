name: Build GL-MT2500 IPK New

env:
  TZ: Asia/Shanghai

on:
  workflow_dispatch:
    inputs:
      pkgname:
        type: choice
        required: true
        default: "NetSpeedTest"
        options:
          - openclash
          - passwall
          - passwall2
          - passwall_packages
          - smartdns
          - NetSpeedTest
  # push:
  #   branches:
  #     - main
  #   paths:
  #     - 'build_ipks.sh'


jobs:
  build_package:
    permissions:
      actions: write #  to cancel/stop running workflows (styfle/cancel-workflow-action)
      contents: write #  to create release tags (cycjimmy/semantic-release-action)
    runs-on: ubuntu-20.04
    steps:
      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          docker rmi `docker images -q`
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /etc/mysql /etc/php
          sudo -E apt-get -y purge azure-cli* docker* ghc* zulu* hhvm* llvm* firefox* google* dotnet* aspnetcore* powershell* openjdk* adoptopenjdk* mysql* php* mongodb* moby* snap* || true
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install libfuse-dev $(curl -fsSL git.io/depends-ubuntu-2204)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: Checkout
        uses: actions/checkout@master

      - name: build ipk
        id: build
        env:
          PKGNAME: ${{ inputs.pkgname }}
        run: |
          cd $GITHUB_WORKSPACE
          chmod +x ./build_ipks.sh
          ./build_ipks.sh

      - uses: actions/upload-artifact@main
        with:
          name: ${{ inputs.pkgname }}
          path: |
            ./buildsource
            ./openwrt-sdk/bin/NetSpeedTest/packages/aarch64_cortex-a53/*ipk


      - name: Commit packages
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git clone  --depth 1 -b Packages https://github.com/AoThen/Openwrt-Packages --single-branch
          cd Openwrt-Packages
          rm -rf ${{ inputs.pkgname }}
          mkdir ${{ inputs.pkgname }}
          cp -rf $GITHUB_WORKSPACE/openwrt-sdk/bin/* ${{ inputs.pkgname }}/

          git add .
          Emoji=("🎉" "✨" "🎁" "🎈" "🎄" "🍓" "🍕" "🍉" "🌴" "🚀" "⛅" "🌈" "❤️")
          git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]}update at $(TZ='Asia/Shanghai' date +%Y-%m-%d)${Emoji[$[$RANDOM % ${#Emoji[@]}]]}"


# echo "CRTDIRTEMP=$PWD" >> $GITHUB_ENV
# zip -r ${{ inputs.pkgname }}.zip ${{ inputs.pkgname }}/packages/aarch64_cortex-a53

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ github.token }}
          repository: "AoThen/Openwrt-Packages"
          branch: "Packages"
          directory: "Openwrt-Packages"
          force: true

      # - name: Commit packages
      #   run: |
      #     git clone  --depth 1 -b Packages https://github.com/AoThen/Openwrt-Packages --single-branch
      #     cd Openwrt-Packages
      #     rm -rf luci-app-openclash
      #     mkdir luci-app-openclash
      #     cp -rf $GITHUB_WORKSPACE/buildsource/openclash/* luci-app-openclash/
      #     echo "CRTDIRTEMP=$PWD" >> $GITHUB_ENV
      #     git add .
      #     Emoji=("🎉" "✨" "🎁" "🎈" "🎄" "🍓" "🍕" "🍉" "🌴" "🚀" "⛅" "🌈" "❤️")
      #     git commit -m "${Emoji[$[$RANDOM % ${#Emoji[@]}]]}update at $(TZ='Asia/Shanghai' date +%Y-%m-%d)${Emoji[$[$RANDOM % ${#Emoji[@]}]]}"
      #     zip -r luci-app-openclash.zip luci-app-openclash


      # - name: Push changes
      #   uses: ad-m/github-push-action@master
      #   with:
      #     github_token: ${{ github.token }}
      #     repository: "AoThen/Openwrt-Packages"
      #     branch: "Packages"
      #     directory: "Openwrt-Packages"
      #     force: true

      # - name: Upload firmware to release
      #   uses: softprops/action-gh-release@v1
      #   with:
      #     tag_name: luci-app-openclash
      #     body: luci-app-openclash
      #     token: ${{ github.token }}
      #     files: ${{ env.CRTDIRTEMP }}/luci-app-openclash.zip


      # - name: Delete workflow runs
      #   uses: Mattraks/delete-workflow-runs@v2
      #   with:
      #     token: ${{ github.token }}
      #     repository: ${{ github.repository }}
      #     retain_days: 30
      #     keep_minimum_runs: 8